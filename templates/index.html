<!DOCTYPE html>
<html>
<head>
    <title>My Chat App</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    
    <style>
        body { font-family: Arial, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; background: #f0f0f0; margin: 0; }
        #app-container {
            width: 800px;
            height: 600px;
            background: #fff;
            display: flex;
            flex-direction: row;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        /* --- User List (Left Side) --- */
        #user-list-container {
            width: 250px;
            border-right: 1px solid #ccc;
            display: flex;
            flex-direction: column;
            background: #f5f5f5;
        }
        #user-list-container h3 {
            padding: 15px;
            margin: 0;
            border-bottom: 1px solid #eee;
            text-align: center;
        }
        #user-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
            overflow-y: auto;
        }
        #user-list li {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        #user-list li:hover {
            background: #e0e0e0;
        }
        #user-list li.active {
            background: #007bff;
            color: white;
            font-weight: bold;
        }
        /* --- Chat Area (Right Side) --- */
        #chat-container {
            flex-grow: 1; /* Take remaining space */
            display: flex;
            flex-direction: column;
        }
        #chat-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            font-weight: bold;
            background: #f5f5f5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #callButton {
            display: none; 
            padding: 5px 8px; 
            background: #28a745; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer;
        }
        #callButton:hover {
            background: #218838;
        }
        #messages {
            list-style-type: none;
            padding: 10px;
            margin: 0;
            overflow-y: scroll;
            flex-grow: 1;
        }
        #messages li {
            padding: 8px 12px;
            margin-bottom: 10px;
            border-radius: 10px;
            word-wrap: break-word;
            max-width: 70%;
        }
        /* Style for messages from "other" person */
        #messages li.other {
            background: #e0f7fa;
            align-self: flex-start;
        }
        /* Style for messages from "me" */
        #messages li.me {
            background: #dcf8c6;
            align-self: flex-end;
            margin-left: auto; /* Push to the right */
        }
        #input-area { display: flex; padding: 10px; border-top: 1px solid #eee; }
        #messageInput { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 5px; }
        #sendButton { padding: 8px 15px; margin-left: 10px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="app-container">
        
        <div id="user-list-container">
            <h3>Online Users</h3>
            <ul id="user-list">
                </ul>
        </div>
        
        <div id="chat-container">
            <div id="chat-header">
                <span id="chat-with-text">Select a user to chat</span>
                <button id="callButton">ðŸ“ž Call</button>
            </div>
            
            <ul id="messages">
                </ul>
            <div id="input-area">
                <input id="messageInput" autocomplete="off" placeholder="Type a message..." />
                <button id="sendButton">Send</button>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', (event) => {
            var socket = io();

            // --- Page Elements ---
            var userList = document.getElementById('user-list');
            var messagesList = document.getElementById('messages');
            var messageInput = document.getElementById('messageInput');
            var sendButton = document.getElementById('sendButton');
            var chatHeader = document.getElementById('chat-header');
            var chatWithText = document.getElementById('chat-with-text'); // Get the new <span>
            var callButton = document.getElementById('callButton');
            
            // --- App State ---
            let myUsername = '';
            let currentChatPartner = null;
            let chatHistories = {}; // This is our new cache

            // --- 1. Ask for username and Join ---
            while (!myUsername) {
                myUsername = prompt("What is your name?");
                if (myUsername === null) {
                    // Handle user clicking "Cancel"
                    myUsername = '';
                }
            }
            socket.emit('join', myUsername);

            // --- 2. Listen for User List Updates ---
            socket.on('user_list', function(usernames) {
                userList.innerHTML = ''; // Clear the list
                let activeUserStillOnline = false;
                
                usernames.forEach(function(username) {
                    if (username === myUsername) return; // Don't list myself
                    
                    var li = document.createElement('li');
                    li.textContent = username;
                    li.dataset.username = username; // Store username in data attribute
                    
                    // Add click event
                    li.onclick = function() {
                        handleUserClick(username);
                    };
                    
                    userList.appendChild(li);
                    
                    if (username === currentChatPartner) {
                        activeUserStillOnline = true;
                    }
                });

                // Re-select active user if they are still online
                if (activeUserStillOnline) {
                    highlightActiveUser(currentChatPartner);
                } else if (currentChatPartner) {
                    // The person you were chatting with disconnected
                    chatWithText.textContent = `Select a user to chat`; 
                    messagesList.innerHTML = `<li style="text-align: center; font-style: italic;">${currentChatPartner} has disconnected.</li>`;
                    callButton.style.display = 'none';
                    currentChatPartner = null;
                }
            });
            
            // --- 3. Handle Clicking a User (UPDATED with cache) ---
            async function handleUserClick(username) {
                // 1. Save the current chat (if one is open)
                if (currentChatPartner) {
                    chatHistories[currentChatPartner] = messagesList.innerHTML;
                }

                // 2. Set the new chat partner
                currentChatPartner = username;
                chatWithText.textContent = `Chat with ${username}`; // Only change the text
                callButton.style.display = 'inline-block'; // Show call button
                
                // 3. Remove any "New Message" notification
                const userLi = userList.querySelector(`li[data-username="${username}"]`);
                if (userLi) {
                    userLi.textContent = username; // Reset text
                    userLi.style.fontWeight = 'normal';
                    highlightActiveUser(username);
                }

                // 4. Check if we have this chat in our cache
                if (chatHistories[username]) {
                    // 4a. Yes: Load from cache
                    messagesList.innerHTML = chatHistories[username];
                } else {
                    // 4b. No: Fetch from server
                    messagesList.innerHTML = ''; // Clear chat window
                    try {
                        const response = await fetch(`/get_history/${username}`);
                        const history = await response.json();
                        history.forEach(function(msg) {
                            displayMessage(msg.sender_username, msg.content);
                        });
                        // Save the fetched history to cache
                        chatHistories[username] = messagesList.innerHTML;
                    } catch (err) { 
                        console.error('Error fetching history:', err);
                    }
                }
                
                scrollToBottom();
            }

            // --- 4. Listen for New Private Messages (UPDATED with notifications) ---
            socket.on('private_message', function(data) {
                // 'data' is {sender: 'some_user', msg: 'hello'}
                let chatPartner = (data.sender === myUsername) ? currentChatPartner : data.sender;
                
                // Check if it's for the currently active chat
                if (data.sender === currentChatPartner || data.sender === myUsername) {
                    displayMessage(data.sender, data.msg);
                    scrollToBottom();
                    // Save the new message to the cache
                    if (currentChatPartner) {
                        chatHistories[currentChatPartner] = messagesList.innerHTML;
                    }
                } else {
                    // It's for an inactive chat. Show a notification.
                    const userLi = userList.querySelector(`li[data-username="${data.sender}"]`);
                    if (userLi) {
                        userLi.textContent = `${data.sender} (New Message!)`;
                        // *** THIS IS THE FIX ***
                        // It is now 'bold' not '.bold'
                        userLi.style.fontWeight = 'bold';
                    }
                    
                    // Add to the cache for that user, even if inactive
                    if (!chatHistories[data.sender]) {
                        chatHistories[data.sender] = ''; // Initialize if it doesn't exist
                    }
                    let tempLi = document.createElement('li');
                    // We must display the sender name for inactive chats
                    tempLi.className = 'other';
                    tempLi.textContent = `${data.sender}: ${data.msg}`;
                    chatHistories[data.sender] += tempLi.outerHTML;
                }
            });

            // --- 5. Send a Message ---
            function sendMessage() {
                var messageText = messageInput.value;
                if (messageText.trim() === '' || !currentChatPartner) {
                    return; // Don't send empty messages or if no user is selected
                }
                
                // Send a private message event to the server
                socket.emit('private_message', {
                    'recipient': currentChatPartner,
                    'msg': messageText
                });
                
                messageInput.value = '';
            }

            // --- 6. Call Feature (Simulation) ---
            callButton.onclick = function() {
                if (currentChatPartner) {
                    console.log(`Requesting call with ${currentChatPartner}`);
                    alert(`Calling ${currentChatPartner}...`);
                    socket.emit('request_call', { 'recipient': currentChatPartner });
                }
            };

            // What to do when YOU receive a call
            socket.on('incoming_call', function(data) {
                // data is {sender: 'some_user'}
                console.log(`${data.sender} is calling you.`);
                if (confirm(`${data.sender} is calling you. Do you accept?`)) {
                    console.log('Accepting call...');
                    // This is where you would start the WebRTC process
                    socket.emit('accept_call', { 'recipient': data.sender });
                }
            });
            
            // What to do when the other person accepts your call
            socket.on('call_accepted', function(data) {
                alert(`${data.sender} accepted your call!`);
                // This is where you would start the WebRTC process
            });

            // --- Helper Functions ---
            function displayMessage(sender, message) {
                var li = document.createElement('li');
                
                if (sender === myUsername) {
                    li.className = 'me';
                    li.textContent = message;
                } else {
                    li.className = 'other';
                    li.textContent = `${sender}: ${message}`;
                }
                messagesList.appendChild(li);
            }
            
            function scrollToBottom() {
                messagesList.scrollTop = messagesList.scrollHeight;
            }
            
            function highlightActiveUser(username) {
                // Remove 'active' class from all users
                userList.querySelectorAll('li').forEach(li => li.classList.remove('active'));
                // Add 'active' class to the clicked user
                const userLi = userList.querySelector(`li[data-username="${username}"]`);
                if (userLi) {
                    userLi.classList.add('active');
                }
            }

            // --- Event Listeners for Sending ---
            sendButton.onclick = sendMessage;
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        });
    </script>
</body>
</html>
