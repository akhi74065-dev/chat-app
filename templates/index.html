<!DOCTYPE html>
<html>
<head>
    <title>My Chat App</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    
    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', (event) => {
            var socket = io();

            var messagesList = document.getElementById('messages');
            var messageInput = document.getElementById('messageInput');
            var sendButton = document.getElementById('sendButton');

            // --- New: Ask for username ---
            let username = '';
            while (username.trim() === '') {
                username = prompt("What is your name?");
            }
            // Send the username to the server
            socket.emit('join', username);
            // --- End of new part ---

            function scrollToBottom() {
                messagesList.scrollTop = messagesList.scrollHeight;
            }
            
            scrollToBottom();

            // --- Updated: Handle incoming messages ---
            socket.on('message', function(data) {
                var li = document.createElement('li');

                // Check if data is an object (our chat message) or a string (a join/leave message)
                if (typeof data === 'object') {
                    li.textContent = `${data.name}: ${data.msg}`;
                    // You could style your own messages differently
                    if (data.name === username) {
                        li.style.fontWeight = 'bold';
                        li.style.background = '#dcf8c6'; // A light green
                    }
                } else {
                    // This is a simple string message like "User has joined"
                    li.textContent = data;
                    li.style.fontStyle = 'italic';
                    li.style.textAlign = 'center';
                }
                
                messagesList.appendChild(li);
                scrollToBottom();
            });

            // --- Send Message ---
            function sendMessage() {
                var messageText = messageInput.value;
                if (messageText.trim() !== '') {
                    socket.send(messageText); // Server will get this and add the name
                    messageInput.value = '';
                }
            }

            sendButton.onclick = sendMessage;

            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        });
    </script>
    
    <style>
        /* (Your CSS styling) ... */
        body { font-family: Arial, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; background: #f0f0f0; }
        #chat-container { width: 400px; height: 600px; border: 1px solid #ccc; background: #fff; display: flex; flex-direction: column; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        #messages { list-style-type: none; padding: 10px; margin: 0; overflow-y: scroll; flex-grow: 1; border-bottom: 1px solid #ccc; }
        #messages li { padding: 8px 12px; margin-bottom: 5px; background: #e0f7fa; border-radius: 10px; word-wrap: break-word; }
        #input-area { display: flex; padding: 10px; border-top: 1px solid #eee; }
        #messageInput { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 5px; }
        #sendButton { padding: 8px 15px; margin-left: 10px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        #sendButton:hover { background: #0056b3; }
    </style>
</head>
<body>
    <div id="chat-container">
        <ul id="messages">
            {% for msg in history %}
                <li>{{ msg.username }}: {{ msg.content }}</li>
            {% endfor %}
        </ul>
        
        <div id="input-area">
            <input id="messageInput" autocomplete="off" placeholder="Type a message..." />
            <button id="sendButton">Send</button>
        </div>
    </div>
</body>
</html>
